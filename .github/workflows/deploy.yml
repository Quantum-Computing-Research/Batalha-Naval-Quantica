name: Deploy para EC2 via SCP + SSH

on:
  push:
    branches:
      - backend_serverful

  workflow_dispatch:
    inputs:
      ambiente:
        description: 'Escolha o ambiente de deploy'
        required: true
        default: 'produção'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do código
        uses: actions/checkout@v3

      - name: Enviar código para EC2 via SCP
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "app/*"
          target: "~/app-temp"

      - name: Acessar EC2 e fazer o deploy
        uses: appleboy/ssh-action@v0.1.6
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            sudo rm -rf ~/app
            mv ~/app-temp/app ~/app
            cd ~/app
            sudo docker rm -f flask-app || true
            sudo docker build -t flask-app .
            sudo docker run -d -p 80:5000 --name flask-app flask-app